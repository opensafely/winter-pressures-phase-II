
version: '3.0'

expectations:
  population_size: 1000

actions:

  generate_practice_measures_2016-04-11:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2016-04-11.arrow
      --
      --practice_measures
      --start_intv 2016-04-11
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2016-04-11.arrow

  generate_practice_measures_2017-04-10:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2017-04-10.arrow
      --
      --practice_measures
      --start_intv 2017-04-10
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2017-04-10.arrow

  generate_practice_measures_2018-04-09:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2018-04-09.arrow
      --
      --practice_measures
      --start_intv 2018-04-09
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2018-04-09.arrow

  generate_practice_measures_2019-04-08:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2019-04-08.arrow
      --
      --practice_measures
      --start_intv 2019-04-08
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2019-04-08.arrow

  generate_practice_measures_2020-04-06:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2020-04-06.arrow
      --
      --practice_measures
      --start_intv 2020-04-06
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2020-04-06.arrow

  generate_practice_measures_2021-04-05:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2021-04-05.arrow
      --
      --practice_measures
      --start_intv 2021-04-05
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2021-04-05.arrow

  generate_practice_measures_2022-04-04:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2022-04-04.arrow
      --
      --practice_measures
      --start_intv 2022-04-04
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2022-04-04.arrow

  generate_practice_measures_2023-04-03:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2023-04-03.arrow
      --
      --practice_measures
      --start_intv 2023-04-03
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2023-04-03.arrow

  generate_practice_measures_2024-04-01:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2024-04-01.arrow
      --
      --practice_measures
      --start_intv 2024-04-01
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2024-04-01.arrow

  generate_practice_measures_2025-03-31:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2025-03-31.arrow
      --
      --practice_measures
      --start_intv 2025-03-31
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2025-03-31.arrow

  generate_demograph_measures_2016-04-11:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2016-04-11.arrow
      --
      --demograph_measures
      --start_intv 2016-04-11
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2016-04-11.arrow

  generate_demograph_measures_2017-04-10:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2017-04-10.arrow
      --
      --demograph_measures
      --start_intv 2017-04-10
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2017-04-10.arrow

  generate_demograph_measures_2018-04-09:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2018-04-09.arrow
      --
      --demograph_measures
      --start_intv 2018-04-09
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2018-04-09.arrow

  generate_demograph_measures_2019-04-08:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2019-04-08.arrow
      --
      --demograph_measures
      --start_intv 2019-04-08
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2019-04-08.arrow

  generate_demograph_measures_2020-04-06:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2020-04-06.arrow
      --
      --demograph_measures
      --start_intv 2020-04-06
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2020-04-06.arrow

  generate_demograph_measures_2021-04-05:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2021-04-05.arrow
      --
      --demograph_measures
      --start_intv 2021-04-05
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2021-04-05.arrow

  generate_demograph_measures_2022-04-04:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2022-04-04.arrow
      --
      --demograph_measures
      --start_intv 2022-04-04
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2022-04-04.arrow

  generate_demograph_measures_2023-04-03:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2023-04-03.arrow
      --
      --demograph_measures
      --start_intv 2023-04-03
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2023-04-03.arrow

  generate_demograph_measures_2024-04-01:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2024-04-01.arrow
      --
      --demograph_measures
      --start_intv 2024-04-01
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2024-04-01.arrow

  generate_demograph_measures_2025-03-31:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/demograph_measures/demograph_measures_2025-03-31.arrow
      --
      --demograph_measures
      --start_intv 2025-03-31
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2025-03-31.arrow

  generate_comorbid_measures_2016-04-11:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2016-04-11.arrow
      --
      --comorbid_measures
      --start_intv 2016-04-11
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2016-04-11.arrow

  generate_comorbid_measures_2017-04-10:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2017-04-10.arrow
      --
      --comorbid_measures
      --start_intv 2017-04-10
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2017-04-10.arrow

  generate_comorbid_measures_2018-04-09:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2018-04-09.arrow
      --
      --comorbid_measures
      --start_intv 2018-04-09
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2018-04-09.arrow

  generate_comorbid_measures_2019-04-08:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2019-04-08.arrow
      --
      --comorbid_measures
      --start_intv 2019-04-08
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2019-04-08.arrow

  generate_comorbid_measures_2020-04-06:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2020-04-06.arrow
      --
      --comorbid_measures
      --start_intv 2020-04-06
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2020-04-06.arrow

  generate_comorbid_measures_2021-04-05:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2021-04-05.arrow
      --
      --comorbid_measures
      --start_intv 2021-04-05
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2021-04-05.arrow

  generate_comorbid_measures_2022-04-04:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2022-04-04.arrow
      --
      --comorbid_measures
      --start_intv 2022-04-04
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2022-04-04.arrow

  generate_comorbid_measures_2023-04-03:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2023-04-03.arrow
      --
      --comorbid_measures
      --start_intv 2023-04-03
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2023-04-03.arrow

  generate_comorbid_measures_2024-04-01:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2024-04-01.arrow
      --
      --comorbid_measures
      --start_intv 2024-04-01
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2024-04-01.arrow

  generate_comorbid_measures_2025-03-31:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2025-03-31.arrow
      --
      --comorbid_measures
      --start_intv 2025-03-31
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2025-03-31.arrow

  generate_app_measures_intv_1:
     run: ehrql:v1 generate-measures analysis/appointments/app_measures.py
      --output output/appointments/app_measures_1.csv 
      -- 
      --start_intv 2023-07-01
     outputs:
       moderately_sensitive:
         dataset: output/appointments/app_measures_1.csv
 
  generate_app_measures_intv_2:
     run: ehrql:v1 generate-measures analysis/appointments/app_measures.py
      --output output/appointments/app_measures_2.csv 
      -- 
      --start_intv 2023-12-01
     outputs:
       moderately_sensitive:
         dataset: output/appointments/app_measures_2.csv
 
  generate_app_measures_intv_3:
     run: ehrql:v1 generate-measures analysis/appointments/app_measures.py
      --output output/appointments/app_measures_3.csv 
      -- 
      --start_intv 2018-07-01
     outputs:
       moderately_sensitive:
         dataset: output/appointments/app_measures_3.csv
 
  generate_app_measures_intv_4:
     run: ehrql:v1 generate-measures analysis/appointments/app_measures.py
      --output output/appointments/app_measures_4.csv 
      -- 
      --start_intv 2018-12-01
     outputs:
       moderately_sensitive:
         dataset: output/appointments/app_measures_4.csv
 
  generate_app_processing:
     run: r:v2 analysis/appointments/app_processing.r
     needs: [generate_app_measures_intv_1, generate_app_measures_intv_2, generate_app_measures_intv_3, generate_app_measures_intv_4]
     outputs:
       moderately_sensitive:
         table_rounded: output/appointments/app_measures_rounded_*.csv

  generate_pre_processing_practice:
    run: python:v2 analysis/pre_processing.py --practice_measures 
    needs: [generate_practice_measures_2016-04-11, generate_practice_measures_2017-04-10, generate_practice_measures_2018-04-09, generate_practice_measures_2019-04-08, generate_practice_measures_2020-04-06, generate_practice_measures_2021-04-05, generate_practice_measures_2022-04-04, generate_practice_measures_2023-04-03, generate_practice_measures_2024-04-01, generate_practice_measures_2025-03-31]
    outputs:
      highly_sensitive:
        measures: output/practice_measures/proc_practice_measures.arrow
  generate_pre_processing_demograph:
    run: python:v2 analysis/pre_processing.py --demograph_measures 
    needs: [generate_demograph_measures_2016-04-11, generate_demograph_measures_2017-04-10, generate_demograph_measures_2018-04-09, generate_demograph_measures_2019-04-08, generate_demograph_measures_2020-04-06, generate_demograph_measures_2021-04-05, generate_demograph_measures_2022-04-04, generate_demograph_measures_2023-04-03, generate_demograph_measures_2024-04-01, generate_demograph_measures_2025-03-31]
    outputs:
      highly_sensitive:
        measures: output/demograph_measures/proc_demograph_measures.arrow
  generate_pre_processing_comorbid:
    run: python:v2 analysis/pre_processing.py --comorbid_measures 
    needs: [generate_comorbid_measures_2016-04-11, generate_comorbid_measures_2017-04-10, generate_comorbid_measures_2018-04-09, generate_comorbid_measures_2019-04-08, generate_comorbid_measures_2020-04-06, generate_comorbid_measures_2021-04-05, generate_comorbid_measures_2022-04-04, generate_comorbid_measures_2023-04-03, generate_comorbid_measures_2024-04-01, generate_comorbid_measures_2025-03-31]
    outputs:
      highly_sensitive:
        measures: output/comorbid_measures/proc_comorbid_measures.arrow

  # Rounding
  generate_rounding:
    run: r:v2 analysis/round_measures.r 
    needs: [generate_pre_processing_practice, generate_pre_processing_demograph, generate_pre_processing_comorbid]
    outputs:
      highly_sensitive:
        rounded_measures: output/*/*midpoint6.arrow

  # Normalization
  generate_normalization:
    run: python:v2 analysis/normalization.py 
    needs: [generate_rounding]
    outputs:
      highly_sensitive:
        RR_table: output/practice_measures/RR.arrow
      moderately_sensitive:
        seasonality_table: output/practice_measures/seasonality_results.csv
        trend_table: output/practice_measures/trend_results.csv

  # Visualisation
  generate_tables_demograph:
    run: r:v2 analysis/table_generation.r --demograph_measures 
    needs: [generate_rounding]
    outputs:
     moderately_sensitive:
       tables: output/demograph_measures/plots/*_demograph.csv
       plots: output/demograph_measures/plots/*_demograph.png
  generate_tables_comorbid:
    run: r:v2 analysis/table_generation.r --comorbid_measures 
    needs: [generate_rounding]
    outputs:
     moderately_sensitive:
        tables: output/comorbid_measures/plots/*_comorbid.csv
        plots: output/comorbid_measures/plots/*_comorbid.png

  generate_deciles_charts:
    run: >
      r:v2 analysis/decile_charts.r 
    needs: [generate_rounding] 
    outputs:
      moderately_sensitive:
        deciles_charts: output/practice_measures/plots/decile_chart_*_rate_mp6.png
        deciles_table: output/practice_measures/decile_tables/decile_table_*_rate_mp6.csv
  generate_deciles_charts_RR:
    run: >
      r:v2 analysis/decile_charts.r --RR 
    needs: [generate_normalization]
    outputs:
      moderately_sensitive:
        deciles_charts: output/practice_measures/plots/decile_chart_*_RR.png
        deciles_table: output/practice_measures/decile_tables/decile_table_*_RR.csv


  # --------------- TEST ACTIONS ------------------------------------------

  generate_demograph_measures_test:
    run: ehrql:v1 generate-measures analysis/wp_measures.py 
      --output output/demograph_measures/demograph_measures_2016-04-11_test.csv.gz
      --
      --demograph_measures
      --start_intv 2016-04-11
      --test
    outputs:
      highly_sensitive:
        dataset: output/demograph_measures/demograph_measures_2016-04-11_test.csv.gz
  generate_practice_measures_test:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/practice_measures/practice_measures_2016-04-11_test.csv.gz
      --
      --practice_measures
      --start_intv 2016-04-11
      --test
    outputs:
      highly_sensitive:
        dataset: output/practice_measures/practice_measures_2016-04-11_test.csv.gz
  generate_comorbid_measures_test:
    run: ehrql:v1 generate-measures analysis/wp_measures.py
      --output output/comorbid_measures/comorbid_measures_2016-04-11_test.csv.gz
      --
      --comorbid_measures
      --start_intv 2016-04-11
      --test
    outputs:
      highly_sensitive:
        dataset: output/comorbid_measures/comorbid_measures_2016-04-11_test.csv.gz

  generate_pre_processing_practice_test:
    run: python:v2 analysis/pre_processing.py --practice_measures --test
    needs: [generate_practice_measures_test,]
    outputs:
      highly_sensitive:
        measures: output/practice_measures/proc_practice_measures_test.csv.gz
  generate_pre_processing_demograph_test:
    run: python:v2 analysis/pre_processing.py --demograph_measures --test
    needs: [generate_demograph_measures_test]
    outputs:
      highly_sensitive:
        measures: output/demograph_measures/proc_demograph_measures_test.csv.gz
  generate_pre_processing_comorbid_test:
    run: python:v2 analysis/pre_processing.py --comorbid_measures --test
    needs: [generate_comorbid_measures_test]
    outputs:
      highly_sensitive:
        measures: output/comorbid_measures/proc_comorbid_measures_test.csv.gz

  # Rounding
  generate_rounding_test:
    run: r:v2 analysis/round_measures.r --test
    needs: [generate_pre_processing_practice_test, generate_pre_processing_demograph_test, generate_pre_processing_comorbid_test]
    outputs:
      highly_sensitive:
        rounded_measures: output/*/*midpoint6_test.csv.gz

  # Normalization
  generate_normalization_test:
    run: python:v2 analysis/normalization.py --test
    needs: [generate_rounding_test]
    outputs:
      highly_sensitive:
        RR_table: output/practice_measures/RR_test.csv.gz
      moderately_sensitive:
        seasonality_table: output/practice_measures/seasonality_results_test.csv
        trend_table: output/practice_measures/trend_results_test.csv

  # Visualisation
  generate_tables_demograph_test:
    run: r:v2 analysis/table_generation.r --demograph_measures --test
    needs: [generate_rounding_test]
    outputs:
     moderately_sensitive:
       tables: output/demograph_measures/plots/*_demograph_test.csv
       plots: output/demograph_measures/plots/*_demograph_test.png
  generate_tables_comorbid_test:
    run: r:v2 analysis/table_generation.r --comorbid_measures --test
    needs: [generate_rounding_test]
    outputs:
     moderately_sensitive:
        tables: output/comorbid_measures/plots/*_comorbid_test.csv
        plots: output/comorbid_measures/plots/*_comorbid_test.png

  generate_deciles_charts_test:
    run: >
      r:v2 analysis/decile_charts.r --test
    needs: [generate_rounding_test] 
    outputs:
      moderately_sensitive:
        deciles_charts: output/practice_measures/plots/decile_chart_*_rate_mp6_test.png
        deciles_table: output/practice_measures/decile_tables/decile_table_*_rate_mp6_test.csv
  generate_deciles_charts_RR_test:
    run: >
      r:v2 analysis/decile_charts.r --RR --test
    needs: [generate_normalization_test]
    outputs:
      moderately_sensitive:
        deciles_charts: output/practice_measures/plots/decile_chart_*_RR_test.png
        deciles_table: output/practice_measures/decile_tables/decile_table_*_RR_test.csv

